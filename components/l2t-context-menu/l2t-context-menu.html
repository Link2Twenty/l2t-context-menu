<link rel="import" href="../paper-menu/paper-menu.html" />
<link rel="import" href="../paper-menu/paper-submenu.html" />

<!--
Polymer element to replace right click functionality.

__Example:__

    <l2t-context-menu parentclass="standardExample">
      <paper-item>
        <a href="#">Normal Item</a>
      </paper-item>
    </l2t-context-menu>

    <l2t-context-menu parentclass="submenuExample">
      <paper-submenu opened>
        <paper-item class="menu-trigger">Submenu Head</paper-item>
        <paper-menu class="menu-content">
          <paper-item><a href='#'>Submenu Item</a></paper-item>
        </paper-menu>
      </paper-submenu>
    </l2t-context-menu>

@demo
-->

<dom-module id="l2t-context-menu">
  <style>
  .context-menu {
    display: none;
    position: absolute;
    z-index: 10;
    padding: 12px;
    background-color: var(--context-back-color);
	-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.4);
	box-shadow:0 2px 5px 0 rgba(0,0,0,.4);
  }

  .context-menu--active {
    display: block;
  }

  ::content li, ::content paper-item{
    display: block;
    color: var(--context-head-color);
    padding: 2px;
  }
  
  ::content paper-item {
	cursor: pointer;
  }

  ::content li:last-child {
    margin-bottom: 0;
  }

  ::content a {
    display: block;
    color: var(--context-link-color);
    padding: 4px 12px;
    text-decoration: none;
  }

  ::content a:hover {
    background-color: var(--context-link-color);
    color: var(--context-back-color);
  }
  
  ::content hr {
    border-color: var(--context-sepa-color);
  }
  
  ::content .paper-menu-0{
	background-color: var(--context-back-color);
  }
  </style>
  <template>
    <paper-menu id="context-menu" class="context-menu">
        <content></content>
    </paper-menu>
  </template>
</dom-module>
<script>
  ( function () {
    Polymer({
      is: 'l2t-context-menu',
      properties: {
        /**
        * Sting for storing class name
        * of which classes should be listened too
        *
        * @attribute parentclass
        * @type String
        * @default "default"
        */
        parentclass: {
          type: String,
          value: 'default',
          notify: true
        },
        /**
        * Sting for storing theme color
        * for mouse over and link color
        *
        * @attribute linkcolor
        * @type String
        * @default "#0066aa"
        */
        linkcolor: {
          type: String,
          value: '#0066aa',
          notify: true
        },
        /** 
        * Sting for storing theme color
        * for background color
        *
        * @attribute backcolor
        * @type String
        * @default "#fff"
        */
        backcolor: {
          type: String,
          value: '#fff',
          notify: true
        },
        /** 
        * Sting for storing theme color
        * for standard text color
        *
        * @attribute headcolor
        * @type String
        * @default "#333"
        */
        headcolor: {
          type: String,
          value: '#333',
          notify: true
        },
        /** 
        * Sting for storing theme color
        * for < hr > separaters
        *
        * @attribute sepacolor
        * @type String
        * @default "#9a9a9a"
        */
        sepacolor: {
          type: String,
          value: '#bcbcbc',
          notify: true
        },
      },
      /**
      * Function to set theme colors
      * called when the dom is ready
      *
      */
      themeInit: function() {
        this.customStyle['--context-link-color'] = this.linkcolor;
        this.customStyle['--context-back-color'] = this.backcolor;
        this.customStyle['--context-head-color'] = this.headcolor;
        this.customStyle['--context-sepa-color'] = this.sepacolor;
        this.updateStyles();
      },
      /**
      * Starting the scripts
      * domReady for when the dom is... rea
      *
      */
      ready: function() {
        this.themeInit();
        function clickInsideElement(e,t){
          var n=e.srcElement||e.target;
          if(n.classList.contains(t))return n;
            for(;n=n.parentNode;)
           if(n.classList&&n.classList.contains(t))return n;
            return!1
        }
		// Function to get position
        function getPosition(e){
          var t=0,
          n=0;
          if(!e)var e=window.event;
          return e.pageX||e.pageY?(t=e.pageX,n=e.pageY):
          (e.clientX||e.clientY)&&(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,n=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),
          {x:t,y:n}
        }
		// Function to run all listeners
        function init(){
          contextListener(),
          clickListener(),
          keyupListener(),
          resizeListener()
        }
		// Function to listen for context menu (moves menu to right position)
        function contextListener(){
          document.addEventListener("contextmenu",function(e){
            taskItemInContext=clickInsideElement(e, taskItemClassName),
            taskItemInContext?(e.preventDefault(),toggleMenuOn(),positionMenu(e)):(taskItemInContext=null,toggleMenuOff())
          })
        }
		// Function to listen for clicks (close menu unless submenu)
        function clickListener(){
          document.addEventListener("click",function(e){
            var t=clickInsideElement(e,contextSubmenuClassName);
            if(!t)
              var n=e.which||e.button;
              1===n&&toggleMenuOff()
          })
        }
		// Function listen for ESC kep press (close menu)
        function keyupListener(){
          window.onkeyup=function(e){
            27===e.keyCode&&toggleMenuOff()
          }
        }
		// Function listen for pafe resize (close menu)
        function resizeListener(){
          window.onresize=function(){
            toggleMenuOff()
          }
        }
		// Function show menu, vibrate 25/1000 seconds
        function toggleMenuOn(){
          1!==menuState&&(menuState=1,
          menu.classList.add(contextMenuActive));
		  // Error catcher for IE and Edge
		  if (typeof navigator.vibrate === "function") { 
			navigator.vibrate([25])
		  }
        }
		// Function to hide menu
        function toggleMenuOff(){
          0!==menuState&&(menuState=0,
          menu.classList.remove(contextMenuActive))
        }
		// Function calculates location based on click events
        function positionMenu(e){
          clickCoords=getPosition(e),
          clickCoordsX=clickCoords.x,
          clickCoordsY=clickCoords.y,
          menuWidth=menu.offsetWidth+4,
          menuHeight=menu.offsetHeight+4,
          windowWidth=window.innerWidth,
          windowHeight=window.innerHeight,
          menu.style.left=menuWidth>windowWidth-clickCoordsX?clickCoordsX-menuWidth+"px":clickCoordsX+"px",
          menu.style.top=menuHeight>windowHeight-clickCoordsY?clickCoordsY-menuHeight+"px":clickCoordsY+"px"
        }
		// Variables
        var contextSubmenuClassName="menu-trigger",
        contextMenuActive="context-menu--active",
        taskItemClassName=this.parentclass,
        taskItemInContext,
        clickCoords,
        clickCoordsX,
        clickCoordsY,
        menu=Polymer.dom(this.root).querySelector("#context-menu"),
        menuState=0,
        menuWidth,
        menuHeight,
        windowWidth,
        windowHeight;
		// Call init to get the call rolling
        init();
      }
    });
  })();
</script>
